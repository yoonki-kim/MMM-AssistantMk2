"use strict";const path=require("path"),Record=require("@bugsounet/node-lpcm16"),B2M=require("@bugsounet/node-buffertomp3"),Snowboy=require("@bugsounet/snowboy").Snowboy,GoogleAssistant=require("google-assistant"),exec=require("child_process").exec,fs=require("fs");var NodeHelper=require("node_helper"),log=(...o)=>{};module.exports=NodeHelper.create({start:function(){this.config={},this.continueConversation=!1,this.speaker=null},play:function(o,e,t,i=(()=>{})){const n=require("play-sound")();this.sendSocketNotification("SPEAKER_ON");var r={};r[e]=t,this.speaker=n.play(o,r,o=>{if(o&&!o.killed)throw console.log("Speaker error:",o),o;this.sendSocketNotification("SPEAKER_OFF"),i()})},playChime:function(o){var e=this.config.play.playProgram,t=this.config.play.playOption,i=path.resolve(__dirname,"resources",this.config.startChime);this.play(i,e,t,()=>{o()})},playResponse:function(o,e){this.sendSocketNotification("RESPONSING");var t=this.config.play.playProgram,i=this.config.play.playOption;this.play(o,t,i,()=>{fs.unlink(o,o=>{o&&console.log("[AMK2] Clearing response file error:",o)}),e()})},clearTmp:function(){var o=path.resolve(__dirname,"tmp");exec("cd "+o+"; rm *.mp3; rm *.html",(o,e,t)=>{log("Temporal storage directory is clearing.")})},initializeAfterLoading:function(o,e){console.log("[AMK2] MMM-AssistantMk2 Version:",require("./package.json").version),this.config=o,this.config.debug&&(log=((...o)=>{console.log("[AMK2]",...o)})),this.clearTmp(),this.snowboy=new Snowboy(this.config.snowboy,this.config.record,o=>{this.hotwordDetect(o)},this.config.debug),this.snowboy.init(),console.log("[AMK2] AssistantMk2 is initialized."),e()},socketNotificationReceived:function(o,e){switch(o){case"INIT":this.initializeAfterLoading(e,()=>{this.sendSocketNotification("INITIALIZED")});break;case"START":this.prepareActivate(e);break;case"SNOWBOY_START":this.snowboy.start();break;case"SNOWBOY_STOP":this.snowboy.stop()}},prepareActivate:function(){this.playChime(()=>{this.activate()})},activate:function(){var o,e={auth:{keyFilePath:path.resolve(__dirname,"./credentials.json"),savedTokensPath:path.resolve(__dirname,"./token.json")},conversation:{audio:{encodingIn:"LINEAR16",sampleRateIn:16e3,encodingOut:"MP3",sampleRateOut:24e3},lang:this.config.lang,deviceLocation:{coordinates:this.config.coordinates},screen:{isOn:!1}}},t=new GoogleAssistant(e.auth);t.on("ready",()=>{log("Assistant READY"),t.start(e.conversation)}).on("started",e=>{log("Conversation starts.");let t="",i=null,n=0;var r=Date.now()+".mp3",s="tmp/"+r,a=path.resolve(__dirname,s),c=new B2M({debug:this.config.debug,file:a,verbose:!1});e.on("audio-data",o=>{n+=c.getAudioLength();try{o.length>0&&c.add(o)}catch(o){i=o,console.error("[AMK2] E:",o),console.log("[AMK2] Some error happens. Try again.")}}).on("end-of-utterance",()=>{log("end-of-utterance"),o.stop(),this.sendSocketNotification("MIC_OFF")}).on("transcription",o=>{log("Transcription:",o.transcription," --- Done:",o.done),this.sendSocketNotification("TRANSCRIPTION",o),o.done&&(t=o.transcription)}).on("ended",(o,e)=>{if(e&&(this.continueConversation=e),o)return console.error("[AMK2] Conversation Error:",o),void this.sendSocketNotification("CONVERSATION_ERROR",o);o=null,setTimeout(()=>{c.close();var s={finalTranscription:t,audioSize:n,audioError:i,responseFile:r,continueConversation:e,error:o};s.audioSize<=0?(s.audioError="NO RESPONSE AUDIO IS RETURNED.",s.error=s.audioError,console.log("[AMK2]",s.audioError),this.sendSocketNotification("CONVERSATION_ERROR",s.error),this.sendSocketNotification("CONVERSATION_END",s)):this.playResponse(a,()=>{log("Conversation Completed"),this.sendSocketNotification("RESPONSE_END",s),setTimeout(()=>{this.sendSocketNotification("CONVERSATION_END",s)},10)})},100)}).on("error",o=>{c.close(),console.error("[AMK2] Conversation Error:",o),this.sendSocketNotification("CONVERSATION_ERROR",o)});var l={device:null,recorder:"arecord",threshold:0,sampleRate:16e3,verbose:!1,debug:this.config.debug};let d=Object.assign({},l,this.config.record);o=new Record(d,e,o=>{o&&console.log("[AMK2] Recorder Error: "+o)}),this.sendSocketNotification("MIC_ON"),o.start()}).on("error",e=>{o.stop(),this.sendSocketNotification("MIC_OFF"),console.error("[AMK2] Assistant Error:",e),this.sendSocketNotification("ASSISTANT_ERROR",e)})},hotwordDetect:function(o){o&&this.sendSocketNotification("ASSISTANT_ACTIVATE")}});
